%% ------------------------------------------------------------------------%
% EE 569 Homework #3
% Date: Nov. 1, 2015
% Name: Faiyadh Shahid
% ID: 4054-4699-70
% Email: fshahid@usc.edu
%------------------------------------------------------------------------%
function Subtractive_image = shrinking(Hole_filled_image, row,col)

%% Useless Masks
mask_Conditional = [[0 0 1 0 1 0 0 0 0];[1 0 0 0 1 0 0 0 0];[0 0 0 0 1 0 1 0 0];[0 0 0 0 1 0 0 0 1];    % S1
                    [0 0 0 0 1 1 0 0 0];[0 1 0 0 1 0 0 0 0];[0 0 0 1 1 0 0 0 0];[0 0 0 0 1 0 0 1 0];    % S2
                    [0 0 1 0 1 1 0 0 0];[0 1 1 0 1 0 0 0 0];[1 1 0 0 1 0 0 0 0];[1 0 0 1 1 0 0 0 0];    % S3
                    [0 0 0 1 1 0 1 0 0];[0 0 0 0 1 0 1 1 0];[0 0 0 0 1 0 0 1 1];[0 0 0 0 1 1 0 0 1];    % S3
                    [0 0 1 0 1 1 0 0 1];[1 1 1 0 1 0 0 0 0];[1 0 0 1 1 0 1 0 0];[0 0 0 0 1 0 1 1 1];    % STK4
                    [1 1 0 0 1 1 0 0 0];[0 1 0 0 1 1 0 0 1];[0 1 1 1 1 0 0 0 0];[0 0 1 0 1 1 0 1 0];    % ST5
                    [0 1 1 0 1 1 0 0 0];[1 1 0 1 1 0 0 0 0];[0 0 0 1 1 0 1 1 0];[0 0 0 0 1 1 0 1 1];    % ST5
                    [1 1 0 0 1 1 0 0 1];[0 1 1 1 1 0 1 0 0];[1 1 1 0 1 1 0 0 0];[0 1 1 0 1 1 0 0 1];    % STK6
                    [1 1 1 1 1 0 0 0 0];[0 1 1 1 1 0 1 0 0];[1 0 0 1 1 0 1 1 0];[0 0 0 1 1 0 1 1 1];    % STK6
                    [0 0 0 0 1 1 1 1 1];[0 0 1 0 1 1 0 1 1];                                            % STK6
                    [1 1 1 0 1 1 0 0 1];[1 1 1 1 1 0 1 0 0];[1 0 0 1 1 0 1 1 1];[0 0 1 0 1 1 1 1 1];    % STK7
                    [0 1 1 0 1 1 0 1 1];[1 1 1 1 1 1 0 0 0];[1 1 0 1 1 0 1 1 0];[0 0 0 1 1 1 1 1 1];    % STK8
                    [1 1 1 0 1 1 0 1 1];[0 1 1 0 1 1 1 1 1];[1 1 1 1 1 1 1 0 0];[1 1 1 1 1 1 0 0 1];    % STK9
                    [1 1 1 1 1 0 1 1 0];[1 1 0 1 1 0 1 1 1];[1 0 0 1 1 1 1 1 1];[0 0 1 1 1 1 1 1 1];    % STK9
                    [1 1 1 0 1 1 1 1 1];[1 1 1 1 1 1 1 0 1];[1 1 1 1 1 0 1 1 1];[1 0 1 1 1 1 1 1 1]];   % STK10

mask_Unconditional_without_D = [[0 0 1 0 1 0 0 0 0];[1 0 0 0 1 0 0 0 0];                                            % Spur
                                [0 0 0 0 1 0 0 1 0];[0 0 0 0 1 1 0 0 0];                                            % S4 connected
                                [0 0 1 0 1 1 0 0 0];[0 1 1 0 1 0 0 0 0];[1 1 0 0 1 0 0 0 0];[1 0 0 1 1 0 0 0 0];    % L cluster
                                [0 0 0 1 1 0 1 0 0];[0 0 0 0 1 0 1 1 0];[0 0 0 0 1 0 0 1 1];[0 0 0 0 1 1 0 0 1];    % L cluster
                                [0 1 1 1 1 0 0 0 0];[1 1 0 0 1 1 0 0 0];[0 1 0 0 1 1 0 0 1];[0 0 1 0 1 1 0 1 0];    % 4th connected offset
                                [0 1 1 0 1 0 1 0 0];[1 0 0 1 1 0 0 0 1];[0 0 1 1 1 0 1 0 0];[1 0 0 0 1 0 0 1 1];    % Spur corner 
                                [0 0 1 0 1 1 1 0 0];[1 1 0 0 1 0 0 0 1];[0 0 1 0 1 0 1 1 0];[1 0 0 0 1 1 0 0 1];    
                                [0 1 1 0 1 1 1 0 0];[1 1 0 1 1 0 0 0 1];[0 0 1 1 1 0 1 1 0];[1 0 0 0 1 1 0 1 1];    
                                [0 1 0 1 1 1 0 0 0];[1 1 0 1 1 1 0 0 0];[0 1 0 1 1 1 1 0 0];[1 1 0 1 1 1 1 0 0];    % Tee Branch
                                [0 1 1 1 1 1 0 0 0];[0 1 0 1 1 1 0 0 1];[0 1 1 1 1 1 0 0 1];                        
                                [0 0 0 1 1 1 0 1 0];[0 0 1 1 1 1 0 1 0];[0 0 0 1 1 1 0 1 1];[0 0 1 1 1 1 0 1 1];    
                                [1 0 0 1 1 1 0 1 0];[0 0 0 1 1 1 1 1 0];[1 0 0 1 1 1 1 1 0];                        
                                [0 1 0 1 1 0 0 1 0];[1 1 0 1 1 0 0 1 0];[0 1 1 1 1 0 0 1 0];[1 1 1 1 1 0 0 1 0];    
                                [0 1 0 1 1 0 1 1 0];[0 1 0 1 1 0 0 1 1];[0 1 0 1 1 0 1 1 1];                        
                                [0 1 0 0 1 1 0 1 0];[0 1 0 0 1 1 1 1 0];[0 1 0 0 1 1 0 1 1];[0 1 0 0 1 1 1 1 1];    
                                [1 1 0 0 1 1 0 1 0];[0 1 1 0 1 1 0 1 0];[1 1 1 0 1 1 0 1 0];                        
                                [0 1 0 0 1 1 1 0 0];[1 1 0 0 1 1 1 0 0];[0 1 0 0 1 1 1 0 1];[1 1 0 0 1 1 1 0 1];    % Diagonal branch
                                [0 1 0 1 1 0 0 0 1];[0 1 1 1 1 0 0 0 1];[0 1 0 1 1 0 1 0 1];[0 1 1 1 1 0 1 0 1];    
                                [0 0 1 1 1 0 0 1 0];[1 0 1 1 1 0 0 1 0];[0 0 1 1 1 0 0 1 1];[1 0 1 1 1 0 0 1 1];
                                [1 0 0 0 1 1 0 1 0];[1 0 1 0 1 1 0 1 0];[1 0 0 0 1 1 1 1 0];[1 0 1 0 1 1 1 1 0]];

mask_Unconditional_with_D = [[1 1 0 1 1 0 0 0 0];                                                                   % Corner cluster
                             [1 0 1 0 1 0 1 0 0];[1 0 1 0 1 0 0 1 0];[1 0 1 0 1 0 0 0 1];[1 0 1 0 1 0 1 1 0];       % Vee Branch
                             [1 0 1 0 1 0 0 1 1];[1 0 1 0 1 0 1 0 1];[1 0 1 0 1 1 1 1 1];[1 0 0 0 1 0 1 0 1];
                             [1 0 0 0 1 1 1 0 0];[1 0 1 0 1 0 1 0 0];[1 0 0 0 1 1 1 0 1];[1 0 1 0 1 1 1 0 0];
                             [1 0 1 0 1 0 1 0 1];[1 0 1 0 1 1 1 0 1];[0 0 1 0 1 0 1 0 1];[0 1 0 0 1 0 1 0 1];
                             [1 0 0 0 1 0 1 0 1];[0 1 1 0 1 0 1 0 1];[1 1 0 0 1 0 1 0 1];[1 0 1 0 1 0 1 0 1];
                             [1 1 1 0 1 0 1 0 1];[1 0 1 0 1 0 0 0 1];[0 0 1 1 1 0 0 0 1];[0 0 1 0 1 0 1 0 1];
                             [1 0 1 1 1 0 0 0 1];[0 0 1 1 1 0 1 0 1];[1 0 1 0 1 0 1 0 1];[1 0 1 1 1 0 1 0 1]];
                         
Mask_D = [[1 1 0 1 1 0 0 0 0];[1 0 1 0 1 0 1 0 0];[1 0 1 0 1 0 0 1 0];[1 0 1 0 1 0 0 0 1];[1 0 1 0 1 0 1 1 0];      % Vee Branch
         [1 0 1 0 1 0 0 1 1];[1 0 1 0 1 0 1 0 1];[1 0 1 0 1 1 1 1 1];[1 0 0 0 1 0 1 0 1];   
         [1 0 0 0 1 1 1 0 0];[1 0 1 0 1 0 1 0 0];[1 0 0 0 1 1 1 0 1];[1 0 1 0 1 1 1 0 0];   
         [1 0 1 0 1 0 1 0 1];[1 0 1 0 1 1 1 0 1];[0 0 1 0 1 0 1 0 1];[0 1 0 0 1 0 1 0 1];   
         [1 0 0 0 1 0 1 0 1];[0 1 1 0 1 0 1 0 1];[1 1 0 0 1 0 1 0 1];[1 0 1 0 1 0 1 0 1];   
         [1 1 1 0 1 0 1 0 1];[1 0 1 0 1 0 0 0 1];[0 0 1 1 1 0 0 0 1];[0 0 1 0 1 0 1 0 1];   
         [1 0 1 1 1 0 0 0 1];[0 0 1 1 1 0 1 0 1];[1 0 1 0 1 0 1 0 1];[1 0 1 1 1 0 1 0 1]]; 
     
%% Main Thinning
Initial_image = logical(extension(Hole_filled_image,3)); 
Mask_image=zeros(row+2,col+2);

for r =2:row-1
    for c =2:col-1
        if Initial_image(r,c)~=0
            win=Initial_image(r-1:r+1,c-1:c+1);
            win=[win(1,:) win(2,:) win(3,:)];
            if maskcompare(win,mask_Conditional) ==1
                 Mask_image(r,c)=1;
            end
        else  Mask_image(r,c)=0;
        end
        end
end 
% figure;imshow(Mask_image);

Subtractive_image=zeros(row+2,col+2);

for r=2:row-1
    for c = 2:col-1
        if Mask_image(r,c)~=0
            win=Mask_image(r-1:r+1,c-1:c+1);
            win=[win(1,:) win(2,:) win(3,:)];
            if maskcompare(win,mask_Unconditional_without_D) ==1 
                Subtractive_image(r,c)= Initial_image(r,c);
            else
            for i=1:size(Mask_D,1)
                dont_care(i,:)=and(win,Mask_D(i,:));
                val=maskcompare(dont_care(i,:),mask_Unconditional_with_D(i,:));
               if val==1 
                   Subtractive_image(r,c) = Initial_image(r,c);
                   break;
               else Subtractive_image(r,c) = 0;
               end
            end
            end
        elseif Mask_image(r,c)~=1
            Subtractive_image(r,c) = Initial_image(r,c);
        end
    end
end
Subtractive_image = Subtractive_image(2:row+1,2:col+1);
end
